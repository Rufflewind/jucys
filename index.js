(()=>{var e={2859(e){e.exports={"g.line *":{transition:"fill 0.3s, fill-opacity 0.3s, stroke 0.3s, stroke-opacity 0.3s"},"g.line path.bg,\ng.line path.fg,\ng.line path.hit":{fill:"none"},"g.line path.bg":{stroke:"#ffffff",strokeOpacity:.7,strokeWidth:10,strokeLinecap:"round"},"g.line path.hit":{strokeOpacity:0,strokeWidth:25,strokeLinecap:"round"},"g.line:hover path.hit":{stroke:"#e3bd2e",strokeOpacity:.2},"g.arrow:hover circle.hit":{fill:"#e3bd2e",fillOpacity:.2},"g.node:hover circle.hit":{fill:"#e3bd2e",fillOpacity:.2},"g.line path.fg":{strokeWidth:2,stroke:"#051308"},"g.line path.pith":{fill:"none",stroke:"none"},"g.line.summed path.fg":{strokeWidth:6},"g.line.summed path.pith":{stroke:"white",strokeWidth:2},"g.line text.label":{fill:"#051308",alignmentBaseline:"middle",textAnchor:"middle",fontSize:"large"},"g.line.two-j text.label":{fill:"#3274b0"},"g.line.two-j path.fg":{stroke:"#3274b0"},"g.line.two-j .arrowhead":{fill:"#3274b0"},"g.line.zero path.fg":{stroke:"#a89a9f",fontWeight:"bold"},"g.line.zero text.label":{fill:"#a89a9f",fontWeight:"bold"},"g.line.zero .arrowhead":{fill:"#a89a9f",fontWeight:"bold"},"g.arrow.ambient .arrowhead":{opacity:.35},"g.arrow.bad .hit":{fill:"#e74551"},"g.arrow.bad .arrowhead":{fill:"#e74551"},"g.arrow.bad.external .arrowhead":{fill:"#dcb406"},"g.arrow.bad circle.arrowhead":{opacity:.7},"g.arrow circle.hit":{fillOpacity:0},"g.node *":{transition:"fill 0.3s, fill-opacity 0.3s"},"g.node circle.bg,\ng.node circle.hit":{fill:"#ffffff",fillOpacity:0},"g.node circle.fg":{fill:"#dddddd"},"g.node text.label":{alignmentBaseline:"middle",textAnchor:"middle",fontSize:"large"},"g.node.w3j circle.fg":{fill:"#21b0ae"},"g.node.w3j circle.fg.flipped":{fill:"#8d74c5"},"g.node.w3j use.arrow":{fill:"white"},"g.node.w3j use.arrow.flipped":{transform:"scale(-1,1)"},"g.node.terminal circle.fg":{fill:"#000000",fillOpacity:.3},"g.node.terminal:hover circle.fg":{fill:"#646464",fillOpacity:.3},"g.node.terminal circle.fg.frozen":{fillOpacity:0}}}},t={};function n(r){var i=t[r];if(void 0!==i)return i.exports;var s=t[r]={exports:{}};return e[r](s,s.exports,n),s.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";var e=n(2859),t=n.n(e);function r(e){return e}function i(e,t){return e==t}function s(e,t){return e<t?-1:t<e?1:0}function o(e,t,n){const r=e.length,i=t.length,o=r<i?r:i;for(let r=0;r<o;++r){const i=n(e[r],t[r]);if(i)return i}return s(r,i)}function l(e,t){let n=new Map;for(const[r,i]of t.entries()){if(n.has(i))return 0;n.set(i,e[r])}let r=new Set(e),i=1;for(;r.size;){const e=r.values().next().value;r.delete(e);let t=e;do{if(!n.has(t))return 0;t=n.get(t),r.delete(t),i*=-1}while(t!=e);i*=-1}return i}function a(e){return e>0?1:e<0?-1:0}function c(e,t){return(e%t+t)%t}function u(e,t,n){return n<e?e:n>t?t:n}function d(e,t){return e?t+e/2-c(t+e/2,e):t}function p(e,t){return e^t}function*f(e,t){for(let n=e;n<t;++n)yield n}function*h(e,t,n){n=n||0;for(const r of t)yield e(r,n),n+=1}function*g(e,t){for(const n of t)e(n)&&(yield n)}function*m(e,t){let n=0;for(const r of t){if(n>=e)break;yield r,n+=1}}function y(e,t){e=e.slice(),(t=Array.from(t)).sort((e,t)=>t-e);const n=t.length;for(let r=0;r<n;++r){if(t[r]>=e.length)throw new Error("index out of range");e.splice(t[r],1)}return e}let w=0;const b=new WeakMap;function v(e,t,n){return e.hasOwnProperty(t)?e[t]:n}function j(e){return JSON.parse(JSON.stringify(e))}function O(e,t,n,r,i,s){const o=n-i,l=r-s,c=i-e,u=s-t,d=e-n,p=t-r,f=l*d-p*o;if(0==f)return 0;const h=(d*c+p*u)/f,g=.5*Math.sqrt(Math.pow(o-l*h,2)+Math.pow(l+o*h,2));return-a(l*c-o*u)*g-h/2*Math.sqrt(o*o+l*l)}function x(e,...t){e=Array.from(e);for(const n of t)for(const[t,r]of n.entries())e[t]+=r;return e}function I(e,...t){e=Array.from(e);for(const n of t)for(const[t,r]of n.entries())e[t]-=r;return e}function k(e,t){let n=0;for(const r of e.keys())n+=e[r]*t[r];return n}function S(e,t){t=Array.from(t);for(const n of t.keys())t[n]*=e;return t}const $={ZERO:0,ONE:1,add:(e,t)=>e+t,subtract:(e,t)=>e-t,multiply:(e,t)=>e*t,divide:(e,t)=>{if(!t)throw new Error("division by zero");return e/t},eq:i},E=Object.assign({},$,{add:p,subtract:p}),z=(D=D||i,P=void 0===P?0:P,class e{constructor(e){if(this.data=new Map,e)for(const[t,n]of e)this.set(t,n)}copy(){return new e(this)}[Symbol.iterator](){return this.data.entries()}keys(){return this.data.keys()}get(e){const t=this.data;return t.has(e)?t.get(e):P}set(e,t){D(t,P)?this.delete(e):this.data.set(e,t)}modify(e,t){this.set(e,t(this.get(e)))}delete(e){this.data.delete(e)}map(t){return new e(h(([e,n])=>[e,t(n,e)],this))}toTable(e){e=e||this.keys();let t={};for(const n of e)t[n]=this.get(n);return t}});var D,P;const M=(N=N||z,class e{constructor(e){if(this.data=new Map,e)for(const[t,n,r]of e)this.set(t,n,r)}copy(){return new e(this)}*[Symbol.iterator](){for(const[e,t]of this.rows())yield*h(([t,n])=>[e,t,n],t)}rows(){return h(e=>[e,this.row(e)],this.data.keys())}row(e){return function(e,t){if(!e.has(t)){const n=new N;return e.set(t,n),n}return e.get(t)}(this.data,e)}rowKeys(){return this.data.keys()}colKeys(){let e=new Set;for(const t of this.data.values())for(const n of t.keys())e.add(n);return e}get(e,t){return this.row(e).get(t)}set(e,t,n){this.row(e).set(t,n)}modify(e,t,n){this.set(e,t,n(this.get(e,t)))}deleteRow(e){this.data.delete(e)}map(t){return new e(h(([e,n,r])=>[e,n,t(r,n,e)],this))}toTable(e,t){e=e||this.rowKeys(),t=t||Array.from(this.colKeys());let n={};for(const r of e)n[r]=this.row(r).toTable(t);return n}});var N;const L=Symbol("VNODE_KEY"),A=Symbol("VNODE_SUSPEND_CHILDREN"),H=Symbol("VNODE_SYMBOLS"),q=Symbol("VNODE_EVENT_LISTENERS");function R(e,t){let n=t[q],r=Object.assign({},n);const i=Object.keys(e);let s=i.length;for(;s--;){const o=i[s],l=e[o];let a=/^on(.+)/.exec(o);if(a){const e=a[1];n||(n={},t[q]=n);let i=n[e];i?delete r[e]:(i=[void 0],n[e]=i,t.addEventListener(e,function(e){return i[0].call(this,e)})),i[0]=l}else null==l?t.removeAttribute(o,l):t.getAttribute(o)!=l&&t.setAttribute(o,l)}const o=Object.getOwnPropertySymbols(e);for(s=o.length;s--;){let n=t[H];n||(n={},t[H]=n);const r=o[s];n[r]=e[r]}const l=Object.keys(r);let a=l.length;for(;a--;){const e=l[a];t.removeEventListener(e,r[e])}}function B(e,t){if(!e)return;let n=t.childNodes;if(!n)return;let r=document.createDocumentFragment(),i=0;for(let s=0;s<e.length;++s){let o=e[s],l=n[i];if(o instanceof T){const e=o.attributes[L];if(e)for(;l;){if(l instanceof Element||l instanceof Text){if((l[H]||{})[L]==e)break;t.removeChild(l)}else t.insertBefore(r,l),i+=1;l=n[i]}else l&&(l[H]||{})[L]&&(l=null);if(l){if(l instanceof HTMLElement?l.nodeName.toLowerCase()==o.name.toLowerCase():l.namespaceURI==o.namespace&&l.nodeName==o.name){t.insertBefore(r,l),i+=1,o.renderTo(l);continue}t.removeChild(l)}o=o.create()}else if("string"==typeof o){if(l instanceof Text){t.insertBefore(r,l),i+=1,l.nodeValue!=o&&(l.nodeValue=o);continue}o=document.createTextNode(o)}r.appendChild(o)}for(;i<n.length;){let e=n[i];e instanceof Element||e instanceof Text?t.removeChild(e):i+=1}t.appendChild(r)}class T{constructor(e,t,n,r){this.namespace=e,this.name=t,this.attributes=n,this.children=r}renderTo(e){!function(e,t){if(!e)return;let n=t.attributes;if(n){let t=0;for(;t<n.length;){const r=n[t],i=r.name;e.hasOwnProperty(i)||null!=r.ns?t+=1:n.removeNamedItem(i)}}delete t[H],R(e,t)}(this.attributes,e),this.attributes[A]||B(this.children,e)}create(){const e=this.namespace;let t=e?document.createElementNS(e,this.name):document.createElement(this.name);return this.renderTo(t),t}}const C={svg:"http://www.w3.org/2000/svg",xlink:"http://www.w3.org/1999/xlink"};function _(e,t,...n){let r;return[r,e]=function(e){let t=null;const n=/([^:]+):(.+)/.exec(e);return n&&C.hasOwnProperty(n[1])&&(t=C[n[1]],e=n[2]),[t,e]}(e),new T(r,e,t,n)}let X=[];function Y(...e){let t=[],n={};return e.forEach(e=>e.forEach(e=>{if(e.length<2)return;let r=null;for(let t=0;t<e.length&&(r=n[e[t]],!r);++t);null==r&&(r=[[]],t.push(r[0])),e.forEach(e=>{const t=n[e];t?t[0]!=r[0]&&(r[0].push(...t[0]),t[0].splice(0,t[0].length),t[0]=r[0]):(r[0].push(e),n[e]=r)})})),Object.freeze(t.map(Object.freeze).filter(e=>e.length>1))}function K(e,t){e=Y(e),t=Y(t);let n={};e.forEach(e=>e.forEach(t=>n[t]=e));for(let e=0;e<t.length;++e){const r=t[e];let i=null;for(let e=0;e<r.length&&(i=n[r[e]],!i);++e);if(!i)return!1;for(let e=0;e<r.length;++e)if(n[r[e]]!=i)return!1}return!0}function U(e,t){return K(e,t)&&K(t,e)}function W(e,t){for(let n=0;n<e.length;++n)for(let r=0;r<e[n].length;++r)if(e[n][r]==t)return[n,r];return null}function J(e,t){const n=W(e,t);if(!n)return[t];const[r,i]=n;return[t].concat(y(e[r],[i]))}const Z=Object.freeze({phase:0,summed:!1,weight:0});function F(e){return Object.freeze(Object.assign({},Z,e))}function V(e){const t=/^([\s\S]*?)(\d*)$/.exec(e);return t[1]+(Number(t[2])+1).toString()}function G(e){return g(t=>!e.hasOwnProperty(t),h(e=>e.toString(),f(1,Number.POSITIVE_INFINITY)))}function Q(e){let t=Object.assign({},e.superlines);for(const n of e.deltas)for(const e of n)t[e]=!0;return G(t)}function ee(e){return!e.phase&&!e.summed&&!e.weight}function te(...e){let t=Object.assign({},Z);return e.forEach(e=>{t.phase=c(t.phase+(e.phase||0),4),t.weight+=e.weight||0,null!=e.summed&&(t.summed=e.summed)}),Object.freeze(t)}function ne(...e){let t={};for(const n of e)for(const e of Object.keys(n)){if("0"==e){t[e]=Z;continue}const r=t[e];let i=n[e];r&&(i=te(r,i)),t[e]=i}for(const e of Object.keys(t))0!=e.phase||0!=e.weight||e.summed||delete t[e];return Object.freeze(t)}const re=Object.freeze({superline:"0",direction:0,arrowPos:.5,arcHeight:0,angle:0,textPos:.5,textOffset:0});function ie(e){return se({superline:e})}function se(e){return Object.freeze(Object.assign({},re,e))}function oe(e){return null!=(e=Object.assign({},e)).direction&&(e.direction=-e.direction),null!=e.arrowPos&&(e.arrowPos=1-e.arrowPos),null!=e.arcHeight&&(e.arcHeight=-e.arcHeight),null!=e.angle&&(e.angle=c(e.angle+Math.PI,2*Math.PI)),null!=e.textPos&&(e.textPos=1-e.textPos),null!=e.textOffset&&(e.textOffset=-e.textOffset),Object.freeze(e)}function le(e){return"0"==e.superline||1==c(e.direction,2)}function ae(...e){return c(function(e){let t=0;for(const n of e)t+=n;return t}(e)+1,4)-1}function ce(...e){e.length;const t=["arrowPos","arcHeight","textPos","textOffset"];let n={},r=0,i=0,s=0,o={};for(const e of t)o[e]=0;for(const[l,a]of e.entries()){if(0==l)n.superline=a.superline;else if(n.superline!=a.superline)throw new Error("cannot add lines with different superlines");null!=a.direction&&(null==n.direction&&(n.direction=0),n.direction=ae(n.direction,a.direction));for(const e of t)null!=a[e]&&(null==n[e]&&(n[e]=0),n[e]+=a[e],o[e]+=1);null!=a.angle&&(r+=Math.sin(a.angle),i+=Math.cos(a.angle),s+=1)}for(const e of t)o[e]&&(n[e]/=o[e]);return s&&(n.angle=Math.atan2(r,i)),Object.freeze(n)}function ue(...e){const t=de(ce(...e.map(t=>Object.assign({},t,{superline:e[0].superline}))));return{line:t.line,phase:t.phase,delta:e.map(e=>e.superline)}}function de(e){let t=e.direction%2,n=2*c(Math.trunc(e.direction/2),2);return"0"==e.superline&&(t=0,n=0),{line:Object.freeze(Object.assign({},e,{direction:t})),phase:n}}function pe(e,t){const n=e.lines[t],r=we(e.nodes,t),i=e.nodes[r[0]],s=e.nodes[r[1]];return Object.assign({external:[i.type,s.type].includes("terminal")},function(e,t,n,r,i){const s=(e+n)/2,o=(t+r)/2;let l=n-e,d=r-t,p=Math.sqrt(l*l+d*d);const f=0==p,h=Math.atan2(d,l);let g=h,m=i.arcHeight;const y=c(i.angle+Math.PI/2,2*Math.PI)<Math.PI?-1:1;if(f){const c=.01;l=c*Math.cos(i.angle),d=c*Math.sin(i.angle),e=s-.5*l,t=o-.5*d,n=s+.5*l,r=o+.5*d,p=c,g=i.angle,m=0==m?50*y:a(m)*u(50,1/0,Math.abs(m))}const w=function(e,t){if(0==t)return{inclination:0,radius:1/0,large:!1,sweep:!1};const n=e/2,r=(n*n/t+t)/2,i=Math.abs(t)>n,s=t<0,o=Math.asin(n/r);return{inclination:i?(s?-1:1)*Math.PI-o:o,radius:r,large:i,sweep:s}}(p,m),b=(w.radius-m)/p,v=s+b*d,j=o-b*l,O={xCenter:v,yCenter:j,startAngle:Math.atan2(t-j,e-v)};return{x0:e,y0:t,x1:n,y1:r,xMid:s,yMid:o,dx:l,dy:d,angle:g,trueAngle:h,lineLength:p,singular:f,line:i,halfDisk:y,arcHeight:m,arc:Object.assign(w,O)}}(i.x,i.y,s.x,s.y,n))}function fe(e,t,n){let r,i;if(0==e.arcHeight){const s=t-e.x0,o=n-e.y0;r=(e.dx*s+e.dy*o)/Math.pow(e.lineLength,2),i=-(s*e.dy-o*e.dx)/e.lineLength}else{const s=e.arc,o=t-s.xCenter,l=n-s.yCenter,u=Math.abs(Math.PI/s.inclination),d=.5*u-.5;r=c((s.startAngle-Math.atan2(l,o))/(2*s.inclination)+d,u)-d,i=(Math.sqrt(o*o+l*l)-Math.abs(s.radius))*a(e.arcHeight)}return{pos:r,offset:i}}function he(e,t,n){const r=e.arc;if(0==e.arcHeight){const r=e.lineLength,i=t+n/r;return{x:e.x0+e.dx*i,y:e.y0+e.dy*i,normalX:-e.dy/r,normalY:e.dx/r,tangentAngle:e.angle}}{const i=2*r.inclination*t+n/r.radius,s=e.angle+r.inclination-i,o=s+Math.PI/2,l=Math.cos(o),a=Math.sin(o);return{x:r.xCenter+r.radius*l,y:r.yCenter+r.radius*a,normalX:l,normalY:a,tangentAngle:s}}}function ge(e,t,n,r){let i={type:"terminal",lines:Object.freeze([e]),variable:t};return null!=n&&(i.x=n),null!=r&&(i.y=r),Object.freeze(i)}function me(e,t,n,r,i){let s={type:"w3j",lines:Object.freeze([e,t,n])};return void 0!==r&&(s.x=r),void 0!==i&&(s.y=i),Object.freeze(s)}function ye(e,t){let n=[];if(null==t)throw new Error("lineId must not be null / undefined");const r=e.length;for(let i=0;i<r;++i){const r=e[i].lines,s=r.length;for(let e=0;e<s;++e)r[e]==t&&n.push([i,e])}if(2!=n.length)throw new Error(`line must be connected at 2 points, not ${n.length}`);return n}function we(e,t){return ye(e,t).map(e=>e[0])}function be(e,t,n){const r=e[t].lines[n];if(void 0===r)throw new Error(`cannot find line with lineIndex = ${n}`);let i=ye(e,r);return 0==o(i[0],[t,n],s)?i[1]:i[0]}function ve(e,t,n){return be(e,t,n)[0]}function je(e,t,n){return o(be(e,t,n),[t,n],s)>0}function Oe(e,t,n,r){return e.map((e,t)=>({distance:Math.pow(n-e.x,2)+Math.pow(r-e.y,2),index:t})).sort((e,t)=>e.distance-t.distance).slice(0,t).map(e=>e.index)}const xe=Object.freeze({nodes:Object.freeze([]),superlines:Object.freeze({}),lines:Object.freeze({}),deltas:Object.freeze([])});function Ie(e){return Object.freeze(Object.assign({},xe,e))}function ke(e,t,n,r,i){if(e==t||t==n||n==e)throw new Error("cannot create w3jDiagram with conflicting labels");return Ie({nodes:Object.freeze([ge(e,e,r-50,i+50),ge(t,t,r+50,i+50),ge(n,n,r,i-70),me(e,t,n,r,i)]),lines:Object.freeze({[e]:ie(e),[t]:ie(t),[n]:ie(n)}),superlines:Object.freeze({[e]:Z,[t]:Z,[n]:Z})})}function Se(e,t,n){const r=e.lines;return Object.freeze(Object.assign({},e,{lines:Object.freeze(Object.assign({},r,{[t]:Object.freeze(Object.assign({},r[t],n))}))}))}function $e(e,t){let n=j(e);n.superlines=ne(e.superlines,t.superlines);let r={};Object.keys(t.lines).forEach(function(e){let i=e;for(;n.lines.hasOwnProperty(i);)i=V(i);r[e]=i,n.lines[i]=t.lines[e]});let i=[];return t.nodes.forEach(function(e){"terminal"==(e=Object.assign({},e,{lines:e.lines.map(e=>r[e])})).type?i.push(e):n.nodes.push(e)}),n.nodes=i.concat(n.nodes),n}function Ee(e,t){for(const n of e.nodes)if("terminal"==n.type&&e.lines[n.lines[0]].superline==t)return!0;return!1}function ze(e,t){let n=(e=j(e)).lines[t];return n.direction>0?n.direction=-1:n.direction<0?n.direction=0:n.direction=1,e}function De(e,t){if("w3j"!=e.nodes[t].type)return e;let n=(e=j(e)).nodes[t].lines;n.reverse();for(let t=0;t<3;++t)if(n[t]==n[(t+1)%3]){e.lines[n[t]]=oe(e.lines[n[t]]);break}return e}function Pe(e,t){const n=Object.keys(e.lines);let r=n.length;for(;r--;)if(e.lines[n[r]].superline==t)return!1;return!0}function Me(e,t){return"w3j"!=e.nodes[t].type||(e=j(De(e,t))).nodes[t].lines.forEach(t=>e.superlines=ne(e.superlines,{[e.lines[t].superline]:{phase:1}})),e}class Ne{constructor(e,t,n){console.assert(e),this.diagram=e,this.id=t,this.reversed=Boolean(n),Object.freeze(this)}get rawLine(){return this.diagram.rawDiagram.lines[this.id]}get line(){return(this.reversed?oe:r)(this.diagram.rawDiagram.lines[this.id])}get superline(){return this.diagram.superline(this.superlineId)}get superlineId(){return this.line.superline}get direction(){return null==this.rawLine.direction?null:this.rawLine.direction*(1-2*this.reversed)}node(e){const t=this.diagram._lineEnds[this.id];return new Le(this.diagram,t[(this.reversed+e)%2*2])}lineIndex(e){return this.diagram._lineEnds[this.id][(this.reversed+e)%2*2+1]}cycNodeLine(e,t){return this.node(e).line((this.lineIndex(e)+t)%3)}toString(){return(this.reversed?"-":"+")+this.id}signedRebase(e){return e.signedLine(this.id,this.reversed)}reverse(){return new Ne(this.diagram,this.id,!this.reversed)}concat(...e){return ce(e.map(e=>e.line))}static removeSign(e){const t=e.substr(1);let n=!1;if("-"==e[0])n=!n;else if("+"!=e[0])throw new Error(`not a valid signed line ID: ${e}`);return[t,n]}rawAssign(e,t,n){e.nodes[this.node(t).index].lines[this.lineIndex(t)]=n}testCuttability(){let e=[Te(this),Te(this.reverse())].filter(r);return 2==e.length?(e.sort((e,t)=>e.priority-t.priority),e[0].error):null}}class Le{constructor(e,t){this.diagram=e,this.index=t,Object.freeze(this)}get rawNode(){return this.diagram.rawDiagram.nodes[this.index]}get type(){return this.rawNode.type}get variable(){if("terminal"!=this.type)throw new Error("node is not a terminal");return this.rawNode.variable}get numLines(){return this.rawNode.lines.length}line(e){const t=this.rawNode.lines[e],n=this.diagram._lineEnds[t],r=n[2]==this.index&&n[3]==e;return new Ne(this.diagram,t,r)}lines(){return h(e=>this.line(e),f(0,this.numLines))}get xy(){return[this.rawNode.x,this.rawNode.y]}}class Ae{constructor(e){this.rawDiagram=Object.freeze(e)||xe,this._cache={},Object.freeze(this)}static deserialize(e){return new Ae(JSON.parse(e))}get serialize(){return JSON.stringify(this.rawDiagram)}get _lineEnds(){let e=this._cache.lineEnds;return e||(e=function(e){let t={};return e.nodes.forEach((e,n)=>{e.lines.forEach((e,r)=>{let i=t[e];if(i){if(2!=i.length)throw new Error("line must be connected to exactly 2 nodes");o([i[0],i[1]],[n,r],s)<0?t[e].push(n,r):t[e].splice(0,0,n,r)}else t[e]=[n,r]})}),t}(this.rawDiagram),this._cache.lineEnds=e),e}get terminals(){let e=this._cache.terminals;if(!e){e={};for(const t of this.nodes())if("terminal"==t.type){if(e[t.variable])throw new Error("duplicate terminal variables");e[t.variable]=t}this._cache.terminals=e}return e}terminal(e){return this.terminals[e]}get numNodes(){return this.rawDiagram.nodes.length}node(e){return new Le(this,e)}*nodes(){const e=this.numNodes;for(let t=0;t<e;++t)yield this.node(t)}get lineIds(){return Object.keys(this.rawDiagram.lines)}signedLine(e,t){const[n,r]=Ne.removeSign(e);return this.line(n,r!=Boolean(t))}line(e,t){return new Ne(this,e,t)}lines(){return h(e=>this.line(e),this.lineIds)}get superlines(){return this.rawDiagram.superlines}superline(e){return this.superlines[e]}hasSuperline(e){return!!this.superline(e)}isEquallyConstrained(e,t){return U([J(this.rawDiagram.deltas,e)],[J(t,e)])}renameLines(e){let t={};for(const n of Object.keys(this.rawDiagram.lines))t[e.hasOwnProperty(n)?e[n]:n]=this.rawDiagram.lines[n];const n=this.rawDiagram.nodes.map(t=>Object.freeze(Object.assign({},t,{lines:Object.freeze(t.lines.map(t=>v(e,t,t)))})));return new Ae(Object.assign({},this.rawDiagram,{nodes:Object.freeze(n),lines:Object.freeze(t)}))}desumExposedSuperlines(){return new Ae(Object.assign({},this.rawDiagram,{superlines:ne(this.rawDiagram.superlines,...Object.entries(this.rawDiagram.superlines).map(([e,t])=>Ee(this.rawDiagram,e)?{[e]:{summed:!1}}:{}))}))}renameSuperlines(e){return new Ae(Object.assign({},this.rawDiagram,{lines:Object.freeze(Object.assign({},...Object.entries(this.rawDiagram.lines).map(([t,n])=>({[t]:Object.freeze(Object.assign({},n,{superline:v(e,n.superline,n.superline)}))})))),superlines:ne(...Object.entries(this.rawDiagram.superlines).map(([t,n])=>({[v(e,t,t)]:n}))),deltas:Y(this.rawDiagram.deltas.map(t=>t.map(t=>v(e,t,t))))})).removeUnusedSuperlines().desumExposedSuperlines()}removeUnusedSuperlines(){let e=Object.assign({},this.rawDiagram.superlines);for(const t of Object.keys(e))ee(e[t])||delete e[t];for(const t of this.lines())delete e[t.superlineId];for(const t of this.rawDiagram.deltas)for(const n of t)delete e[n];let t=Object.assign({},this.rawDiagram.superlines);for(const n of Object.keys(e))delete t[n];return t[0]&&(t[0]=Z),new Ae(Object.assign({},this.rawDiagram,{superlines:t}))}substitute(e,t,n){n=n||{},e=Ie(e),t=Ie(t);const i=this.rawDiagram,a=new Ae(e);let c=new Ae(t),u=[i.deltas,t.deltas];if(!K(i.deltas,e.deltas))throw new Error("mismatch in deltas");let d={},p={};for(const e of a.lines()){const t=Ne.removeSign(e.id)[0],n=p[t];if(n){if("terminal"!=n.node(0).type&&"terminal"!=n.node(1).type||"terminal"!=e.node(0).type&&"terminal"!=e.node(1).type)throw new Error("a single internal line cannot match multiple lines");if("terminal"==e.node(0).type&&"terminal"==e.node(1).type)throw new Error("a lone pattern line cannot be shared");if(d[e.id]||d[n.id])throw new Error("looped lines can only appear twice");d[e.id]=n.id,d[n.id]=e.id}else p[t]=e}let f=Object.assign({},i.lines);for(const e of a.lines()){const t=Ne.removeSign(e.id)[0];console.assert(f[t]||d[e.id]),delete f[t]}let m=G(f),w={};for(const e of c.lines())(e.id.startsWith("$")||f.hasOwnProperty(e.id))&&(w[e.id]=m.next().value);c=c.renameLines(w),t=c.rawDiagram;let b=[i.superlines],v=new Set;for(const n of Object.keys(e.superlines)){const r=e.superlines[n],s=i.superlines[n];if(r.summed){if("0"!=n){if(!s.summed)throw new Error("expected summed superline");if(r.weight!=s.weight)throw new Error("weight of summed superline must match");if(r.phase!=s.phase)throw new Error("phase of summed superline must match");if(!this.isEquallyConstrained(n,t.deltas))throw new Error("deltas of summed superline must match");v.add(n)}b.push({[n]:{summed:!1}})}b.push({[n]:{weight:-r.weight,phase:-r.phase}})}for(const n of Object.keys(t.superlines))if(t.superlines[n].summed){const t=e.superlines[n];if(t){if(!t.summed)throw new Error("summed variable conflicts with pattern")}else if(i.superlines[n])throw new Error("summed variable conflicts with original")}b.push(t.superlines);for(const e of a.nodes()){if("terminal"==e.type)continue;if(0==e.numLines)throw new Error("singleton nodes are not supported");const t=e.line(0).signedRebase(this).node(0);if(t.type!=e.type)throw new Error("node type mismatch");const n=Array.from(t.rawNode.lines),r=Array.from(e.rawNode.lines);if("w3j"==t.type){const e=l(n,n),t=l(n,r.map(e=>Ne.removeSign(e)[0]));if(e&&0==t)throw new Error("node lines mismatch");t<0&&b.push({[n[0]]:{phase:1}},{[n[1]]:{phase:1}},{[n[2]]:{phase:1}})}else if(0!=o(n,r,s))throw new Error("node lines mismatch")}let j=new Set;for(const e of a.lines()){const t=e.node(0),n=e.node(1),r=e.signedRebase(this);if(r.superlineId!=e.superlineId)throw new Error("superline ID mismatch in lines");if("terminal"!=t.type&&"terminal"!=n.type&&null!=e.direction){const t=ae(r.direction,-e.direction);if("0"!=r.superlineId&&t%2!=0)throw new Error("directedness mismatch in lines");b.push({[r.superlineId]:{phase:t}})}j.add(r.id)}new Set(Object.keys(e.superlines));for(const e of this.lines())if(!j.has(e.id)&&v.has(e.superlineId))throw new Error("summed line must not appear outside match");let O=i.nodes.map(e=>Object.assign({},e,{lines:e.lines.slice()})),x=t.nodes.map(e=>Object.assign({},e,{lines:e.lines.slice()})),I={};const k=e=>{let t=[e.line];for(;;){const n=e.node(1),r={type:"replacement",lines:t,line:e,lineId:e.id,nodes:x};if("terminal"!=n.type)return r;const i=a.terminal(n.variable);if(!i)return r;I[e.id]=!0;const s=i.line(0),o=s.signedRebase(this).reverse();"terminal"==s.node(1).type&&s.reversed||t.push(s.line,o.line);const l=d[s.id];if(!l)return{type:"original",lines:t,line:o,lineId:e.id,nodes:O};const u=a.line(l,s.reversed),p=u.node(0);if("terminal"!=p.type)throw new Error("expected terminal node");if(t.push(u.reverse().line),e=c.terminal(p.variable).line(0),I[e.id])return{type:"cycle",lines:t};t.push(e.line)}};function S(e){switch(e.type){case"replacement":return"terminal"==e.line.node(1).type?-1:1;case"original":return 0;default:throw new Error("joining type not valid here")}}for(const e of c.lines()){if(I[e.id])continue;const t=k(e.reverse());if("cycle"==t.type){const e=ue(...t.lines);if(u.push([e.delta]),e.line.direction%2)throw new Error("directed loops are forbidden");b.push({[e.line.superline]:{phase:e.phase,weight:2}});continue}const n=k(e),i=t.lineId,l=t.line.node(1).index,a=n.line.node(1).index,c=t.line.lineIndex(1),d=n.line.lineIndex(1),p=t.lines.map(oe).reverse().concat(n.lines.slice(1)),h=o([S(t),l,c],[S(n),a,d],s)>0?oe:r;t.nodes[l].lines[c]=i,n.nodes[a].lines[d]=i;const g=ue(...p);u.push([g.delta]),console.assert(!f[i]);let m=g.line.superline;for(const e of g.delta)if(!this.superline(e)||!this.superline(e).summed){m=e;break}f[i]=se(h(Object.assign({},g.line,{superline:m}))),b.push({[g.line.superline]:{phase:g.phase}})}const $=Array.prototype.concat(t.nodes.filter((e,t)=>"terminal"==e.type&&!a.terminal(e.variable)),y(O,Array.from(h(e=>e.line(0).signedRebase(this).node(0).index,g(e=>"terminal"!=e.type,a.nodes())))),t.nodes.filter(e=>"terminal"!=e.type)),E=new Ae(Object.assign({},i,{nodes:$,lines:f,superlines:ne(...b),deltas:Y(...u)})).removeUnusedSuperlines();return n.withLineRenames?{diagram:E,lineRenames:w}:E}}function He(e){if("w3j"!=e.type)return"not a Wigner 3-jm symbol";for(let t=0;t<3;++t)if(e.line(t).id==e.line((t+1)%3).id)return{cutLine:e.line((t+2)%3),loopLine:e.line(t)};return"no loops found"}function qe(e,t,n){const r=(e=new Ae(e)).line(t).node(0);if(r.index!=e.line(t).node(1).index)return"no loops found";const i=He(r);if("object"!=typeof i)return i;if(!le(i.loopLine.line))return"loop must be directed";const s=i.cutLine.node(1);if("w3j"!=s.type)return(e=j(e.rawDiagram)).deltas=Y(e.deltas,[[e.lines[i.cutLine.id].superline,"0"]]),e.lines[i.cutLine.id].superline="0",e.superlines[0]=Z,e;if(s.index!=n&&r.index!=n)return"not sure what you're trying to do";const o=i.loopLine,l=i.cutLine,a=i.cutLine.cycNodeLine(1,1).reverse(),c=i.cutLine.cycNodeLine(1,2).reverse();if(c.id==a.id&&!le(c.line))return(e=j(e.rawDiagram)).deltas=Y(e.deltas,[[e.lines[i.cutLine.id].superline,"0"]]),e.lines[i.cutLine.id].superline="0",e.superlines[0]=Z,e;const u=o.toString(),d=l.toString(),p=a.toString(),f=c.toString(),h=o.superlineId,g=l.superlineId,m=a.superlineId,y=c.superlineId;return e.substitute({nodes:[ge(f,"a"),ge(p,"b"),me(u,u,d),me(d,p,f)],lines:{[u]:{superline:h,direction:1},[d]:{superline:g,direction:null},[p]:{superline:m,direction:0},[f]:{superline:y,direction:1}},superlines:{[y]:{weight:1}}},{nodes:[ge("$1","a"),ge("$1","b")],lines:{$1:{superline:m,direction:0,arcHeight:-8*a.line.arcHeight}},superlines:{[h]:{weight:1},0:{}},deltas:[["0",g]]}).rawDiagram}function Re(e,t,n,r,i){let s=(e=new Ae(e)).line(t),o=e.line(n);k(I(s.node(1).xy,s.node(0).xy),I(o.node(1).xy,o.node(0).xy))<0!=Boolean(r)&&(o=o.reverse());const l=x(S(.375,x(s.node(0).xy,o.node(0).xy)),S(.125,x(s.node(1).xy,o.node(1).xy))),a=x(S(.125,x(s.node(0).xy,o.node(0).xy)),S(.375,x(s.node(1).xy,o.node(1).xy))),c=Q(e.rawDiagram).next().value,u=s.node(0).index==o.node(0).index?50:0,d=s.node(1).index==o.node(1).index?50:0;return e.substitute({nodes:[ge(s.toString(),"a"),ge(s.toString(),"b"),ge(o.toString(),"c"),ge(o.toString(),"d")],lines:{[s]:{superline:s.superlineId,direction:0},[o]:{superline:o.superlineId,direction:0}}},{nodes:[ge("$1","a"),ge("$2","b"),ge("$3","c"),ge("$4","d"),me("$1","$3","$5",...l),me("$2","$4","$5",...a)],lines:{$1:{superline:s.superlineId,direction:Number(i),arcHeight:-u},$2:{superline:s.superlineId,direction:Number(i),arcHeight:-d},$3:{superline:o.superlineId,direction:0,arcHeight:u},$4:{superline:o.superlineId,direction:0,arcHeight:d},$5:{superline:c,direction:0}},superlines:{[c]:{phase:0,weight:2,summed:!0}}}).rawDiagram}function Be(e,t){let n=[],r=new z;for(const i of e.lines())"0"!=i.superlineId&&([i.node(0).type,i.node(1).type].includes("terminal")&&(t||i.direction%2==0)&&n.push(i.id),r.set(i.id,1-c(i.direction,2)));let i=new M;for(const t of e.nodes())if("w3j"==t.type)for(const e of t.lines())"0"!=e.superlineId&&i.modify(e.id,t.index,t=>t+(e.reversed?-1:1));let s=r.copy(),o=i.map(e=>c(e,2));for(const e of n)s.delete(e),o.deleteRow(e);const l=function(e,t,n){t=t.copy(),n=n.copy();let r=new Set(t.rowKeys()),i=Array.from(t.colKeys()).reverse(),s=[],o=[];for(const e of n.keys())r.add(e);for(;i.length;){const l=i.pop();let a,c=null;for(const n of r)if(a=t.get(n,l),!e.eq(a,e.ZERO)){c=n;break}if(null==c){s.push(l);continue}o.push([c,l]),r.delete(c);const u=e.divide(e.ONE,a);for(const n of i)t.modify(c,n,t=>e.multiply(u,t));n.modify(c,t=>e.multiply(u,t));for(const s of r){const r=t.get(s,l);if(!e.eq(r,e.ZERO)){for(const n of i)t.modify(s,n,i=>e.subtract(i,e.multiply(r,t.get(c,n))));n.modify(s,t=>e.subtract(t,e.multiply(r,n.get(c))))}}}let l=!0;for(const t of r)if(!e.eq(n.get(t),e.ZERO)){l=!1;break}let a=new n.constructor;for(const t of i)a.set(t,e.ZERO);for(const t of s)a.set(t,e.ZERO);o.reverse();for(const[r,[i,s]]of o.entries()){let l=n.get(i);for(const[n,[s,c]]of o.entries()){if(n>=r)break;l=e.subtract(l,t.get(i,c)*a.get(c))}a.set(s,l)}return{consistent:l,solution:a,unconstrained:s}}(E,o,s),a=function(e,t,n){let r=new n.constructor;for(const[i,s]of t.rows()){let t=e.ZERO;for(const[r,i]of s)t=e.add(t,e.multiply(s.get(r),n.get(r)));r.set(i,t)}return r}($,i,l.solution.map(e=>-e));return{orientable:l.consistent,directions:a,target:s}}function Te(e){const t=function(e){let t=!0,n=!0,r=new Set,i={},s=[e];for(;s.length>0;){const o=s.pop();if(i.hasOwnProperty(o.id)){o.id==e.id&&o.reversed==e.reversed&&(n=!1);continue}const l=o.node(1);"terminal"==l.type&&(t=!1),r.add(l.index),i[o.id]=o.rawLine;for(const e of l.lines())s.push(e)}const o=e.diagram.rawDiagram;return{closed:t,isolated:n,diagram:Object.assign({},o,{nodes:o.nodes.filter((e,t)=>r.has(t)),lines:i})}}(e);if(!t.isolated)return{error:"only bridges can be cut",priority:1};if(!t.closed)return{error:"subdiagram must be closed",priority:2};const n=Object.assign({},t.diagram);return n.lines=Object.assign({},n.lines),n.lines[e.id]=Object.assign({},n.lines[e.id],{superline:"0"}),Be(new Ae(n),!0).orientable?null:{error:"diagram is non-orientable",priority:0}}function Ce(e,t,n,r){const i=t.snapshot.diagram,s=i.nodes[n];let o=[_("svg:title",{},"w3j"==s.type?`{${s.lines.join(" ")}} #${n}`:"terminal"==s.type?`m[${s.variable}] #${n}`:s.type)];if("w3j"==s.type){const e=30,t=function(e,t){const n=e.nodes[t];if("w3j"!=n.type)throw new Error("cannot get orientation of generic node");const r=n.lines.map((n,r)=>{const i=function(e,t,n){const r=e.nodes[t].lines[n],i=e.lines[r],s=pe(e,r),o=Number(je(e.nodes,t,n));return(s.singular?i.angle:s.angle)+o*Math.PI+(o?1:-1)*s.arc.inclination}(e,t,r);return[r,c(i,2*Math.PI)]}).sort((e,t)=>e[1]-t[1]).map(([e,t])=>e);return l([0,1,2],r)}(i,n)>0?"flipped ":"";o.push(_("svg:circle",{class:"bg "+t,r:20})),o.push(_("svg:circle",{class:"fg "+t,r:18})),o.push(_("svg:circle",{class:"hit "+t,r:25})),o.push(_("svg:use",{class:"arrow "+t,href:"#clockwise",x:-e/2,y:-e/2,width:e,height:e}))}else if("terminal"==s.type){const e=r?"frozen ":"";o.push(_("svg:circle",{class:"fg "+e,r:8})),o.push(_("svg:circle",{class:"hit",r:15}))}else o.push(_("svg:circle",{class:"fg",r:20})),o.push(_("svg:circle",{class:"hit",r:25})),o.push(_("svg:text",{class:"label"}));return _("svg:g",{[L]:(a=s,b.has(a)||b.set(a,++w),b.get(a)),class:"node "+s.type+" "+("node"==t.trackStart.type&&t.trackStart.nodeIndex==n||"node"==t.trackStop.type&&t.trackStop.nodeIndex==n?t.trackType+" ":""),transform:`translate(${s.x}, ${s.y})`,onmouseenter:function(t){e(dt({type:"node",nodeIndex:n}))},onmouseleave:function(t){e(dt({type:null}))},onmousedown:function(t){if(1==t.buttons)e(bt(s.x,s.y,{superficial:"w3j"==s.type},(e,t,r,i)=>function(e,t,n){const r=e.nodes;return Object.freeze(Object.assign({},e,{nodes:Object.freeze(Object.assign([],r,{[t]:Object.freeze(Object.assign({},r[t],n))}))}))}(e,n,{x:d(i&&20,t),y:d(i&&20,r)}))),t.stopPropagation();else if(4==t.buttons){if("terminal"==s.type)return;t.shiftKey?e(ot({equivalent:!0},e=>Me(Me(e,n),n))):e(ot({equivalent:!0},e=>Me(e,n))),t.stopPropagation()}else if(2==t.buttons){if("terminal"==s.type)return;e(ot({equivalent:!0},e=>function(e,t){const n=new Ae(e);let r=(e=j(e)).nodes[t];if("w3j"!=r.type)return e;const i=He(n.node(t));let s=null;"object"==typeof i&&i.loopLine.id;let o=0;return r.lines.forEach(function(n,r){const i=e.lines[n];je(e.nodes,t,r)?o-=i.direction:o+=i.direction}),0==o?o=1:-3==o?o=-2:o/=Math.abs(o),r.lines.forEach(function(n,r){let i=Object.assign({},e.lines[n]);je(e.nodes,t,r)?i.direction+=o:i.direction-=o,e.lines[n]=i}),r.lines.forEach(function(t,n){const r=e.lines[t],i=de(r);e.lines[t]=i.line,e.superlines=ne(e.superlines,{[r.superline]:{phase:i.phase}})}),e}(e,n))),t.stopPropagation()}}},...o);var a}function _e(e,t){if("0"==e)return"0"==t?0:-1;if("0"==t)return 1;let n=e.length-t.length;return 0==n&&(n=Number(e>t)-Number(e<t)),n}const Xe={Α:"A",α:"\\alpha",Β:"B",β:"\\beta",Γ:"\\Gamma",γ:"\\gamma",Δ:"\\Delta",δ:"\\delta",Ε:"E",ε:"\\varepsilon",ϵ:"\\epsilon",Ζ:"Z",ζ:"\\zeta",Η:"H",η:"\\eta",Θ:"\\Theta",θ:"\\theta",ϑ:"\\vartheta",Ι:"I",ι:"\\iota",Κ:"K",κ:"\\kappa",ϰ:"\\varkappa",Λ:"\\Lambda",λ:"\\lambda",Μ:"M",μ:"\\mu",Ν:"N",ν:"\\nu",Ξ:"\\Xi",ξ:"\\xi",Ο:"O",ο:"o",Π:"\\Pi",π:"\\pi",ϖ:"\\varpi",Ρ:"P",ρ:"\\rho",ϱ:"\\varrho",Σ:"\\Sigma",σ:"\\sigma",ς:"\\varsigma",Τ:"T",τ:"\\tau",Υ:"Y",ϒ:"\\Upsilon",υ:"\\upsilon",Φ:"\\Phi",φ:"\\varphi",ϕ:"\\phi",Χ:"X",χ:"\\chi",Ψ:"\\Psi",ψ:"\\psi",Ω:"\\Omega",ω:"\\omega"},Ye="ΑαΒβΓγΔδΕεϵΖζΗηΘθϑΙιΚκϰΛλΜμΝνΞξΟοΠπϖΡρϱΣσςΤτΥϒυΦφϕΧχΨψΩω",Ke=`['′_.,\\w${Ye}]`;function Ue(e){return!!new RegExp(`^${Ke}+$`).exec(e)}function We(e){return"w3j"==e.node(0).type&&e.node(0).index==e.node(1).index&&("0"==e.superlineId||e.direction%2)}function Je(e,t,n){const r=n.snapshot.frozen,i=n.focus;return Array.from(new Set(Object.keys(t).concat("0"))).sort(_e).map(s=>{const o="tableauJName"==i.type&&i.superlineId==s,l="0"==s?Z:t[s],a=_("span",{class:"two-j"},"••");let u;switch(c(l.phase,4)){case 0:u=["   "];break;case 1:u=["•  "];break;case 2:u=[a," "];break;case 3:u=[a,"•"]}let d=l.weight?(l.weight>0?"+":l.weight<0?"−":"")+Math.abs(l.weight):"";return _("tr",{},_("td",{class:"summed",onmousedown:function(t){1==t.buttons?(e(lt(e=>function(e,t){if("0"==t)return"";if(Ee(e,t))return"";const n=e.superlines[t];if(n.summed){const n=W(e.deltas,t);if(n){const r=e.deltas,i=r[n[0]][(n[1]+1)%r[n[0]].length],s=e.superlines[t].summed&&e.superlines[i].summed;return e=new Ae(e).renameSuperlines({[t]:i}).rawDiagram,(e=Object.assign({},e)).superlines=Object.assign({},e.superlines),e.superlines[i]=Object.assign({},e.superlines[i],{summed:s}),{equivalent:!0,diagram:e}}}return(e=j(e)).superlines[t].summed=!n.summed,{equivalent:!1,diagram:e}}(e,s))),t.stopPropagation()):4==t.buttons&&(e(lt(e=>function(e,t){const n=Q(e).next().value;return(e=j(e)).superlines[n]=Object.assign({},Z,{summed:!0}),e.deltas=Y(e.deltas,[[t,n]]),{equivalent:!0,diagram:e}}(e,s))),t.stopPropagation())}},l.summed?"∑":""),_("td",{class:"name",contenteditable:"0"!=s,spellcheck:"false",[A]:o,onfocus:function(t){e(pt({type:"tableauJName",superlineId:s}))},onblur:function(t){let n=this.textContent;n=n.trim(),n||(n="0"),e(e=>{lt(e=>{if(e=new Ae(e),s==n||!Ue(n))return"";const t=e.superline(s),i=e.rawDiagram.deltas;if(r&&0==t.phase&&!t.summed&&!W(i,s)){let r=0;for(const t of e.lines())if(t.superlineId==s){if(!We(t)){r=null;break}r+=1}if(null!=r&&t.weight==-r)return{equivalent:!0,diagram:e.renameSuperlines({[s]:n}).rawDiagram}}return{equivalent:t.summed&&!e.superline(n),diagram:e.renameSuperlines({[s]:n}).rawDiagram}})(e),ft(e)})}},"0"==s?_("span",{class:"zero"},"0"):s),_("td",Object.assign({class:"phase "+("phase"==n.drag.type&&n.drag.superlineId==s?"drag ":"")+("phase"==n.drop.type&&n.drop.superlineId==s?"drop ":""),oncontextmenu:function(e){e.preventDefault()},onmousedown:function(t){2==t.buttons?(e(ot({},e=>Object.assign({},e,{superlines:ne(e.superlines,{[s]:{phase:1}})}))),t.stopPropagation(),t.preventDefault()):4==t.buttons&&(e(ot({},e=>Object.assign({},e,{superlines:ne(e.superlines,{[s]:{phase:-1}})}))),t.stopPropagation(),t.preventDefault())}},ht(e,(e,t)=>({type:"phase",superlineId:s})),gt(e,(e,t)=>"phase"!=e.drag.type||e.drag.superlineId==s||e.snapshot.frozen&&!K(e.snapshot.diagram.deltas,[[e.drag.superlineId,s]])?null:{type:"phase",superlineId:s},(e,t)=>{lt(t=>({equivalent:K(t.deltas,[[e.drag.superlineId,s]]),diagram:t=Object.assign({},t,{superlines:ne(t.superlines,{[e.drag.superlineId]:{phase:-1},[s]:{phase:1}})})}))(e)})),...u),_("td",Object.assign({class:"weight "+("weight"==n.drag.type&&n.drag.superlineId==s?"drag ":"")+("weight"==n.drop.type&&n.drop.superlineId==s?"drop ":""),oncontextmenu:function(e){e.preventDefault()},onmousedown:function(t){2==t.buttons?(e(ot({},e=>Object.assign({},e,{superlines:ne(e.superlines,{[s]:{weight:1}})}))),t.stopPropagation(),t.preventDefault()):4==t.buttons&&(e(ot({},e=>Object.assign({},e,{superlines:ne(e.superlines,{[s]:{weight:-1}})}))),t.stopPropagation(),t.preventDefault())}},ht(e,(e,t)=>({type:"weight",superlineId:s})),gt(e,(e,t)=>"weight"!=e.drag.type||e.drag.superlineId==s||e.snapshot.frozen&&!K(e.snapshot.diagram.deltas,[[e.drag.superlineId,s]])?null:{type:"weight",superlineId:s},(e,t)=>{lt(t=>({equivalent:K(t.deltas,[[e.drag.superlineId,s]]),diagram:t=Object.assign({},t,{superlines:ne(t.superlines,{[e.drag.superlineId]:{weight:-1},[s]:{weight:1}})})}))(e)})),d))})}function Ze(e,t){return n=>{const i=n.deltas;let s=null;if((n=Object.assign({},n)).deltas=i.slice(),n.deltas.splice(e,1,...t.split(/[;\n]/).map(e=>e.split("=").map(e=>((e=e.trim())&&!Ue(e)&&(s=e),e)).filter(r))),null!=s)return"invalid label: "+s;n.deltas=Y(n.deltas),n.superlines=Object.assign({},n.superlines);for(const e of n.deltas)for(const t of e)n.superlines[t]||(n.superlines[t]=Z);const o=function(e){let t=[],n=new Set(["0"]);e=new Ae(e);for(const r of e.nodes()){const e=He(r);if("object"==typeof e&&e.loopLine.direction%2&&n.add(e.cutLine.superlineId),"w3j"==r.type)for(const e of r.lines())if(n.has(e.superlineId)){t.push([e.cycNodeLine(0,1).superlineId,e.cycNodeLine(0,2).superlineId]);break}}return t.push(Array.from(n)),t}(n),l=Y(o,i),a=Y(o,n.deltas);let c=U(l,a);if(n=new Ae(n),!c){const e=new Set(J(l,"0")),t=new Set(J(a,"0"));let r=new Set([...e,...t].filter(n=>!e.has(n)||!t.has(n)));const i=["0",...r];if(U(Y([i],l),Y([i],a))){for(const e of n.lines())r.has(e.superlineId)&&!e.testCuttability()&&r.delete(e.superlineId);c=0==r.size}}return{equivalent:c,diagram:n.removeUnusedSuperlines().rawDiagram}}}function Fe(e){return"0"==e?_("span",{class:"zero"},"0"):String(e)}function Ve(e,t,n,r){return _("ul",{},...t.concat([null]).map((t,r)=>{const i="delta"==n.type&&n.deltaIndex==r,s=null==t?[_("i",{},"(create δ)")]:function(e,t){const n=t.length;let r=[];for(let e=0;e<n;++e)0!=e&&r.push(" = "),r.push(t[e]);return r}(0,Array.from(t).map(Fe));return _("li",{class:null==t?"tip ":"",contenteditable:"true",spellcheck:"false",[A]:i,onmousedown:function(t){4==t.buttons&&(e(lt(Ze(r,""))),t.preventDefault())},onfocus:function(n){if(null==t){this.textContent="";let e=document.createRange();e.selectNodeContents(this);let t=window.getSelection();t.removeAllRanges(),t.addRange(e)}e(pt({type:"delta",deltaIndex:r}))},onblur:function(t){const n=this.textContent;e(e=>{lt(Ze(r,n))(e),ft(e)})}},...s)}))}function Ge(e,t){return"j"==e&&"0"==t?"0":`${e}_{${t=t.replace("′","'").replace("_","\\_").replace(new RegExp(`[${Ye}]`),e=>Xe[e]+" ")}}`}function Qe(e,t,n,r){const i=e.nodes[t].lines[n],s=e.lines[i],o=ve(e.nodes,t,n),l=e.nodes[o],a=Ge("m","terminal"==l.type?l.variable:i),c={j:Ge("j",e.lines[i].superline),m:o<t&&0!=s.direction?`-${a}`:a};return s.superline.summed&&(r.js[c.j]=!0),"terminal"!=l.type&&(r.ms[a]=!0),c}const et=4,tt={diagram:xe,frozen:!1,showAmbient:!0};function nt(){return{snapshot:tt,savedSnapshot:tt,savedHash:"",staleEquation:!0,error:"",notice:"An editor for angular momentum diagrams",hover:{type:null},focus:{type:null},drag:{type:null},drop:{type:null},mouseX:null,mouseY:null,trackType:null,trackStart:{type:null,xy:null},trackStop:{type:null,xy:null}}}function rt(e){const t=window.location.hash;t.length<3?Object.assign(e,nt()):e.savedHash!=t&&(e.snapshot=JSON.parse(decodeURIComponent(t.substr(1))),e.staleEquation=!0,e.savedSnapshot=e.snapshot,e.savedHash=t)}function it(e){if(!e)return e;const t=document.getElementById("diagram").getBoundingClientRect();return[e[0]-t.left,e[1]-t.top]}function st(e,t){const n=t.snapshot.diagram;let i=null;return t.snapshot.showAmbient&&(i=Be(new Ae(n),!1),i.orientable||(i=Be(new Ae(n),!0))),[{element:window,attributes:{onhashchange:t=>e(rt),onkeydown:t=>e(Ot.bind(null,t)),onmousemove:t=>{return e((n=t,e=>{const t=document.getElementById("diagram").getBoundingClientRect();var r,i;e.rawMouseX=n.clientX,e.rawMouseY=n.clientY,e.mouseX=n.clientX-t.left,e.mouseY=n.clientY-t.top,e.dragger?(ot(Object.assign({},e.draggerFlags,{transient:!0}),t=>e.dragger(t,n.clientX+e.dragOffsetX,n.clientY+e.dragOffsetY,n.ctrlKey))(e),n.stopPropagation()):function(e){return t=>{null!=t.trackStart.xy&&(t.trackStop.xy=[e.clientX,e.clientY],null!=t.trackStart.type&&("line"==t.hover.type?(t.trackStop.type="line",t.trackStop.lineId=t.hover.lineId):"node"==t.hover.type?(t.trackStop.type="node",t.trackStop.nodeIndex=t.hover.nodeIndex):t.trackStop.type=null))}}(n)(e),r=n.target,i=wt,(r[H]||{})[i]||null!=e.focus.type||n.preventDefault()}));var n},onmouseup:t=>{return e((n=t,e=>{e.dragger?(ot(e.draggerFlags,r)(e),e.dragger=null):function(e,t){(function(e,t){if(null==e.trackStop.xy||e.trackStart.type==e.trackStop.type&&e.trackStart.nodeIndex==e.trackStop.nodeIndex&&e.trackStart.lineId==e.trackStop.lineId&&k(n=I(e.trackStart.xy,e.trackStop.xy),n)<10){if("line"==e.trackStart.type){if("track2"==e.trackType)return void(e.snapshot.frozen?ot({equivalent:!0},t=>function(e,t){return"0"==e.lines[t].superline?(e=j(e)).lines[t].direction=(e.lines[t].direction+2)%3-1:e.lines[t].direction&&((e=j(e)).lines[t].direction*=-1,e.superlines=ne(e.superlines,{[e.lines[t].superline]:{phase:2}})),e}(t,e.trackStart.lineId))(e):ot({},t=>ze(t,e.trackStart.lineId))(e));if("track1"==e.trackType){const t=e.trackStart.lineId;return void(e.snapshot.frozen?ot({equivalent:!0},e=>{const n=function(e,t){let n=new Ae(e).line(t);if(!We(n))return null;if(yt(e,t))return e;const r=Q(e=Object.assign({},e)).next().value,i=e.lines[t].superline;0==n.lineIndex(0)&&2==n.lineIndex(1)&&(n=n.reverse()),e.lines=Object.assign({},e.lines,{[t]:Object.assign({},e.lines[t],{direction:n.reversed?-1:1,superline:r})});const s=-1==n.direction?2:0;return e.superlines=ne(e.superlines,{[i]:F({weight:1,phase:s}),[r]:F({weight:-1})}),new Ae(e).removeUnusedSuperlines().rawDiagram}(e,t);if(n)return n;const r=Object.assign({},e.lines[t]),i=W(e.deltas,r.superline);if(!i)return e;const[s,o]=i;return r.superline=e.deltas[s][(o+1)%e.deltas[s].length],Object.assign({},e,{lines:Object.assign({},e.lines,{[t]:r})})})(e):ot({},e=>{if(yt(e,t))return e;const n=Q(e=Object.assign({},e)).next().value;return e.lines=Object.assign({},e.lines,{[t]:Object.assign({},e.lines[t],{superline:n})}),e.superlines=ne(e.superlines,{[n]:Z}),e})(e))}}}else{const n=it(e.trackStop.xy),r=it(e.trackStart.xy);"track1"==e.trackType?"line"==e.trackStop.type?e.trackStart.lineId==e.trackStop.lineId?ot({equivalent:!0,clearHover:!0},t=>function(e,t){const n=(e=new Ae(e)).line(t),r=n.superline;if(!r.summed)return`j[${n.superlineId}] must be summed over`;if(0!=r.phase)return`j[${n.superlineId}] must not have any phases`;if(2!=r.weight)return`weight of j[${n.superlineId}] must be exactly 2`;if(!e.isEquallyConstrained(n.superlineId,[]))return`j[${n.superlineId}] must not be constrained by deltas`;for(const t of e.lines())if(t.id!=n.id&&t.superlineId==n.superlineId)return`j[${n.superlineId}] must not appear anywhere else`;if("w3j"!=n.node(0).type||"w3j"!=n.node(1).type)return"expected Wigner 3-j symbols";const i=n.cycNodeLine(0,1).reverse(),s=n.cycNodeLine(1,1).reverse(),o=n.cycNodeLine(0,2).reverse(),l=n.cycNodeLine(1,2).reverse();if(i.superlineId!=s.superlineId||o.superlineId!=l.superlineId)return"opposing j's don't match";const a=i.id==o.id?l.id:o.id;return console.assert(i.id,a),e.substitute({nodes:[ge(i.toString(),"a"),ge(s.toString(),"b"),ge(o.toString(),"c"),ge(l.toString(),"d"),me(i.toString(),o.toString(),n.toString()),me(s.toString(),l.toString(),n.toString())],lines:{[i]:{superline:i.superlineId,direction:0},[s]:{superline:s.superlineId,direction:0},[o]:{superline:o.superlineId,direction:0},[l]:{superline:l.superlineId,direction:0},[n]:{superline:n.superlineId,direction:0}},superlines:{[n.superlineId]:{phase:0,weight:2,summed:!0}}},{nodes:[ge(i.id,"a"),ge(i.id,"b"),ge(a,"c"),ge(a,"d")],lines:{[i.id]:{superline:i.superlineId,direction:0},[a]:{superline:o.superlineId,direction:0}}}).rawDiagram}(t,e.trackStart.lineId))(e):ot({equivalent:!0,clearHover:!0},t=>function(e,t,n,r,i){const s=(e=new Ae(e)).line(t),o=e.line(n);return s.id==o.id?e:e.substitute({nodes:[ge(s.toString(),"a"),ge(s.toString(),"b"),ge(o.toString(),"c"),ge(o.toString(),"d")],lines:{[s]:{superline:s.superlineId,direction:1},[o]:{superline:o.superlineId,direction:1}}},{nodes:[ge("$1","a"),ge("$2","b"),ge("$3","c"),ge("$4","d"),me("$1","$2","$5",r[0],r[1]),me("$3","$4","$5",i[0],i[1])],lines:{$1:{superline:s.superlineId,direction:0},$2:{superline:s.superlineId,direction:0},$3:{superline:o.superlineId,direction:0},$4:{superline:o.superlineId,direction:0},$5:{superline:"0",direction:0}},superlines:ne({[s.superlineId]:{weight:1}},{[o.superlineId]:{weight:1}})}).rawDiagram}(t,e.trackStart.lineId,e.trackStop.lineId,r,n))(e):"line"==e.trackStart.type&&ot({equivalent:!0,clearHover:!0},t=>function(e,t,n,r){const i=(e=new Ae(e)).line(t),s=I(r,n),o=Math.atan2(s[1],s[0]);return e.substitute({nodes:[ge(i.toString(),"a"),ge(i.toString(),"b")],lines:{[i]:{superline:i.superlineId,direction:0}}},{nodes:[ge("$1","a"),ge("$2","b"),me("$4","$4","$3",...r),me("$3","$2","$1",...n)],lines:{$4:{superline:"0",direction:1,angle:o-.5*Math.PI,arcHeight:50},$3:{superline:"0",direction:0},$2:{superline:i.superlineId,direction:0,arcHeight:-i.line.arcHeight/4},$1:{superline:i.superlineId,direction:1,arcHeight:-i.line.arcHeight/2}},superlines:{[i.superlineId]:{weight:1}}}).rawDiagram}(t,e.trackStart.lineId,r,n))(e):"track2"==e.trackType&&("line"==e.trackStop.type?e.trackStart.lineId==e.trackStop.lineId?ot({equivalent:!0,clearHover:!0},t=>function(e,t,n,r){const i=(e=new Ae(e)).line(t);if(k(I(n,r),I(i.node(0).xy,i.node(1).xy))<0&&([n,r]=[r,n]),"0"!=i.superlineId){let e=i.testCuttability();if(e)return e}const s=I(n,r),o=Math.atan2(s[1],s[0]),l=e.substitute({nodes:[ge(i.toString(),"a"),ge(i.toString(),"b")],lines:{[i]:{superline:i.superlineId,direction:0}}},{nodes:[ge("$1","a"),ge("$2","b"),me("$1","$3","$3",n[0],n[1]),me("$2","$4","$4",r[0],r[1])],lines:{$1:{superline:i.superlineId,direction:0,arcHeight:-.5*i.line.arcHeight},$2:{superline:i.superlineId,direction:0,arcHeight:-.25*i.line.arcHeight},$3:{superline:"0",direction:0,angle:o+.5*Math.PI,arcHeight:50},$4:{superline:"0",direction:0,angle:o+1.5*Math.PI,arcHeight:50}},deltas:[["0",i.superlineId]]},{withLineRenames:!0});e=l.diagram.rawDiagram;const a=l.lineRenames,c=l.diagram.line(a.$3).id,u=l.diagram.line(a.$4).id;let d=qe(e,c,l.diagram.line(c).node(0).index);return"string"==typeof d?e:(d=qe(e=d,u,new Ae(e).line(u).node(0).index),"string"==typeof d?e:d)}(t,e.trackStart.lineId,r,n))(e):ot({equivalent:!0,clearHover:!0},n=>{let r;for(const i of[!1,!0])if(r=Re(n,e.trackStart.lineId,e.trackStop.lineId,t.shiftKey,i),Be(new Ae(r),!0).orientable)return r;return r})(e):"node"==e.trackStop.type&&ot({equivalent:!0,clearHover:!0},t=>qe(t,e.trackStart.lineId,e.trackStop.nodeIndex))(e))}var n})(e,t),e.trackType=null,e.trackStart={type:null,xy:null},e.trackStop={type:null,xy:null}}(e,n),n.stopPropagation(),n.preventDefault()}));var n}}},{element:document.getElementsByTagName("body")[0],attributes:{class:t.snapshot.frozen?"frozen":""}},{element:document.getElementById("notice"),attributes:{class:t.error?"warning":""},children:[t.error||t.notice]},{element:document.getElementById("freeze"),attributes:{class:t.snapshot.frozen?"active":""}},{element:document.getElementById("ambient"),attributes:{class:t.snapshot.showAmbient?"active":""}},{element:document.getElementById("diagram"),attributes:{oncontextmenu:function(e){e.preventDefault()},onmousedown:t=>{4==t.buttons?(e(mt(t,"track1")),t.stopPropagation()):2==t.buttons&&(e(mt(t,"track2")),t.stopPropagation())}}},{element:document.getElementById("diagram-lines"),children:Object.keys(n.lines).map(n=>function(e,t,n,r){const i=t.snapshot.diagram,s=i.lines[n],o=i.superlines[s.superline],l=pe(i,n),a=he(l,s.textPos,0);let p=s.textOffset;0==p?p=20*l.halfDisk:p>0&&p<20?p=20:p<0&&p>-20&&(p=-20);let f=`M ${l.x0} ${l.y0} `;if(l.arc.radius==1/0)f+="L ";else{const e=Math.abs(l.arc.radius);f+=`A ${e} ${e} 0 ${Number(l.arc.large)} ${Number(l.arc.sweep)} `}f+=`${l.x1} ${l.y1}`;const h=a.x+p*a.normalX,g=a.y+p*a.normalY;function m(t){const[r,i]=it([t.clientX,t.clientY]);1==t.buttons?(e(bt(r,i,{superficial:!0},(e,t,r,i)=>{let s;if(l.singular){const e=t-l.xMid,n=r-l.yMid,o=Math.atan2(n,e)-Math.PI/2,a=Math.sqrt(e*e+n*n);s={angle:d(i&&Math.PI/6,o),arcHeight:u(20,1/0,d(i&&20,a))}}else s={angle:l.trueAngle,arcHeight:d(i&&20,O(t,r,l.x0,l.y0,l.x1,l.y1))};return Se(e,n,s)})),t.stopPropagation()):2==t.buttons&&1==t.ctrlKey&&(e(ot({superficial:!0},e=>l.singular?e:Se(e,n,{angle:l.angle,arcHeight:0}))),t.stopPropagation())}return _("svg:g",{[L]:n,class:"line "+("0"==s.superline?"zero ":"")+(o.summed?"summed ":"")+(o.phase%2?"one-j ":"")+(c(o.phase,4)>=2?"two-j ":"")+("line"==t.trackStart.type&&t.trackStart.lineId==n||"line"==t.trackStop.type&&t.trackStop.lineId==n?t.trackType+" ":""),onmouseenter:function(t){e(dt({type:"line",lineId:n}))},onmouseleave:function(t){e(dt({type:null}))}},_("svg:title",{},`j[${s.superline}] m[${n}]`),_("svg:path",{class:"bg",d:f,onmousedown:m}),_("svg:path",{class:"fg",d:f,onmousedown:m}),_("svg:path",{class:"pith",d:f,onmousedown:m}),_("svg:path",{class:"hit",d:f,onmousedown:m}),_("svg:text",{class:"label",x:h,y:g,onmousedown:function(t){1==t.buttons?(e(bt(h,g,{superficial:!0},(e,t,r,i)=>{const s=fe(l,t,r);return Se(e,n,{textPos:u(.1,.9,d(i&&.1,s.pos)),textOffset:d(i&&10,s.offset)})})),t.stopPropagation()):2==t.buttons&&1==t.ctrlKey&&(e(ot({superficial:!0},e=>Se(e,n,{textPos:.5,textOffset:0}))),t.stopPropagation())}},s.superline),...function(e,t,n,r){const i=t.lines[n];let s=!1,o=!1,l=i.direction;if(r){o=r.target.get(n);const e=r.directions.get(n);s=!l==!e,l=l||e}if(0==l&&!o)return[];i.arrowPos<0?i.arrowPos=0:i.arrowPos>1&&(i.arrowPos=1);const a=pe(t,n),c=15*l/2,p=he(a,i.arrowPos,c),f=he(a,i.arrowPos,0),h=p.tangentAngle+Number(l<0)*Math.PI;return[_("svg:g",{class:"arrow "+(i.direction?"":"ambient ")+(a.external?"external ":"")+(s?"bad ":""),onmousedown:function(t){1==t.buttons?(e(bt(f.x,f.y,{superficial:!0},(e,t,r,i)=>{const s=fe(a,t,r).pos;let o=Object.assign({},e.lines);return o[n]=Object.assign({},o[n],{arrowPos:u(.1,.9,d(i&&.1,s))}),Object.assign({},e,{lines:o})})),t.stopPropagation()):2==t.buttons&&t.ctrlKey&&(e(ot({superficial:!0},e=>{let t=Object.assign({},e.lines);return t[n]=Object.assign({},t[n],{arrowPos:.5}),Object.assign({},e,{lines:t})})),t.stopPropagation())}},_("svg:circle",{class:"hit",r:15,cx:f.x,cy:f.y}),l?_("svg:use",{class:"arrowhead",href:"#arrowhead",x:-15,y:-7.5,width:15,height:15,transform:`translate(${p.x}, ${p.y}) rotate(${180*h/Math.PI})`}):_("svg:circle",{class:"arrowhead",cx:p.x,cy:p.y,r:7.5}))]}(e,i,n,r))}(e,t,n,i))},{element:document.getElementById("diagram-nodes"),children:n.nodes.map((n,r)=>Ce(e,t,r,t.snapshot.frozen))},{element:document.getElementById("diagram-track"),children:null!=t.trackStop.xy?(s=t.trackType,o=it(t.trackStart.xy),l=it(t.trackStop.xy),[_("svg:circle",{class:s,cx:o[0],cy:o[1],r:8}),_("svg:path",{class:s,d:`M ${o[0]} ${o[1]} L ${l[0]} ${l[1]} `}),_("svg:circle",{class:s,cx:l[0],cy:l[1],r:8})]):[]},{element:document.getElementById("tableau-body"),children:Je(e,n.superlines,t)},{element:document.getElementById("delta-tableau"),children:[Ve(e,n.deltas,t.focus,t.snapshot.frozen)]},{element:document.getElementById("equation-container"),attributes:{class:t.staleEquation?"stale":""}},{element:document.getElementById("equation"),attributes:{onclick:t=>{return e((n=t.currentTarget,e=>{e.staleEquation&&(e.staleEquation=!1,function(e,t){const n=e.nodes;let r="",i={js:{},ms:{}},s=[],o=[];n.forEach(function(t,s){if("terminal"==t.type){const r=ve(n,s,0);if(r>s)return;const i=n[r].variable,l=t.variable;if(i==l)return;const a=Ge("m",i),c=Ge("m",l);switch(e.lines[t.lines[0]].direction){case 0:o.push(`\\delta_{${a}, ${c}}`);break;case-1:o.push(`\\delta_{${a}, -${c}}`);break;case 1:o.push(`\\delta_{-${a}, ${c}}`);break;default:throw new Error(`unnormalized direction: ${direction}`)}}else if("w3j"==t.type){r+="\\begin{pmatrix}";let n="",o="";t.lines.forEach(function(t,r){r>0&&(n+=" & ",o+=" & ");const l=Qe(e,s,r,i);n+=l.j,o+=l.m}),r+=n+" \\\\",r+=o+" \\\\",r+="\\end{pmatrix}"}else r+="\\mathtt{${node.type}}_{",t.lines.forEach(function(t,n){n>0&&(r+=" ");const o=Qe(e,s,t,i);r+=o[0]+" "+o[1]}),r+="}"});let l="";Object.keys(e.superlines).forEach(function(t){const n=e.superlines[t],r=Ge("j",t);switch(c(n.phase,4)){case 0:break;case 1:s.push(`+ ${r}`);break;case 2:s.push(`+ 2 ${r}`);break;case 3:s.push(`- ${r}`)}0==n.weight||(2==n.weight?l+=` (2 ${r} + 1)`:n.weight%2==0?l+=` (2 ${r} + 1)^{${n.weight/2}}`:l+=` (2 ${r} + 1)^{${n.weight} / 2}`)}),Object.keys(e.lines).forEach(function(t){const r=e.lines[t];let i;switch(r.direction){case 0:return;case-1:const e=n[we(n,t)[1]];i="terminal"==e.type?e.variable:t;break;case 1:const r=n[we(n,t)[0]];i="terminal"==r.type?r.variable:t;break;default:throw new Error(`unnormalized direction: ${direction}`)}const o=Ge("j",e.lines[t].superline),l=Ge("m",i);s.push(`+ ${o} ${r.direction<0?"+":"-"} ${l}`)});let a=Object.keys(i.js).concat(Object.keys(i.ms)).join(", ");a&&(a=`\\sum_{${a}}`);let u=s.join(" ");u&&(u.startsWith("+ ")&&(u=u.substr(2)),u=`(-1)^{${u}}`);const d=o.join(" "),p=e.deltas.map(e=>{if(e.length<2)return"";const t=Ge("j",e[0]);return e.slice(1).map(e=>`\\delta_{${t} ${Ge("j",e)}}`).join(" ")}).join(" ");t.textContent=`\\[${a} ${p} ${d} ${l} ${u} ${r}\\]`,MathJax.Hub.Queue(["Typeset",MathJax.Hub])}(e.snapshot.diagram,n))}));var n}}}];var s,o,l}function ot(e,t){return lt(n=>Object.assign(e,{diagram:t(n)}))}function lt(e){return t=>{const n=e(t.snapshot.diagram,t.snapshot.frozen);if(null==n||"object"==typeof n&&null==n.diagram)return void ut(t,"not yet implemented");if("string"==typeof n)return void ut(t,n);const r=n.superficial||n.toggleFreeze||n.toggleAmbient,i=n.equivalent||r,s=n.diagram;t.snapshot.frozen&&!i||("string"!=typeof s?(t.snapshot=Object.assign({},t.snapshot,{diagram:s,frozen:Boolean(n.toggleFreeze)!=t.snapshot.frozen,showAmbient:Boolean(n.toggleAmbient)!=t.snapshot.showAmbient}),n.transient||function(e){e.savedSnapshot=e.snapshot,e.savedHash="#"+encodeURIComponent(JSON.stringify(e.snapshot)),window.location.hash=e.savedHash}(t),n.clearHover&&dt({type:null})(t),t.staleEquation=!r||t.staleEquation):ut(t,s))}}function at(e){return e.altKey|e.ctrlKey<<1|e.shiftKey<<2}let ct=0;function ut(e,t){e.error=t,ct&&window.clearTimeout(ct),ct=window.setTimeout(function(){xt(e)(e=>e.error="")},1e4)}function dt(e){return t=>{t.hover=e}}function pt(e){return t=>{t.focus=e}}const ft=pt({type:null});function ht(e,t){return{[wt]:"true",draggable:"true",ondragstart:function(n){n.dataTransfer.setData("text/plain",null),e(e=>{const r=t.call(this,e,n);r&&(e.drag=r)})},ondragend:function(t){e(e=>e.drag={type:null})}}}function gt(e,t,n){function r(t){e(e=>e.drop={type:null})}return{ondragenter:function(n){e(e=>{const r=t.call(this,e,n);r&&(e.drop=r)})},ondragleave:r,ondragexit:r,ondragover:function(n){e(e=>{const r=t.call(this,e,n);r&&(e.drop=r,n.preventDefault())})},ondrop:function(t){e(e=>{t.preventDefault(),n.call(this,e,t),e.drag={type:null},e.drop={type:null}})}}}function mt(e,t){return n=>{n.trackType=t,n.trackStart.xy=[e.clientX,e.clientY],"line"==n.hover.type&&(n.trackStart.type="line",n.trackStart.lineId=n.hover.lineId)}}function yt(e,t){const n=e.lines[t];if("0"==n.superline)return!1;for(const[r,i]of Object.entries(e.lines))if(r!=t&&i.superline==n.superline)return!1;return!W(e.deltas,n.superline)}const wt=Symbol("ENABLE_DRAG");function bt(e,t,n,r){return i=>{i.dragger=r,i.draggerFlags=n,i.dragOffsetX=e-i.rawMouseX,i.dragOffsetY=t-i.rawMouseY}}function vt(e,t){if(!e instanceof Element)return;t(e);let n=e.children;for(const e of f(0,n.length))vt(n[e],t)}let jt;function Ot(e,n){n.snapshot;const i=e=>e(n);if(":"==jt&&"3"==e.key&&(n.notice=jt+e.key),null==n.focus.type){if(0==at(e)&&"r"==e.key)return window.location.href="",void e.preventDefault();if(at(e)==et&&"?"==e.key)return window.location.href=document.getElementById("help-link").href,void e.preventDefault();if(0==at(e)&&"v"==e.key)return i(ot({toggleAmbient:!0},r)),void e.preventDefault();if(null!==n.mouseX){if(0==at(e)&&"f"==e.key)return i(ot({toggleFreeze:!0},r)),void e.preventDefault();if(0==at(e)&&"c"==e.key)return i(ot({},e=>{const t=Array.from(m(3,Q(e)));return $e(e,function(e,t,n,r,i){const s=ke(e,t,n,r,i);return Object.freeze(Object.assign({},s,{nodes:Object.freeze(Object.assign([],s.nodes,{3:Object.freeze(Object.assign({},s.nodes[3],{lines:Object.freeze([e,n,t])}))})),lines:Object.freeze(Object.assign({},s.lines,{[n]:Object.freeze(Object.assign({},s.lines[n],{direction:1}))})),superlines:Object.freeze(Object.assign({},s.superlines,{[t]:Object.freeze(Object.assign({},s.superlines[t],{phase:2})),[n]:Object.freeze(Object.assign({},s.superlines[n],{weight:1}))}))}))}(t[0],t[1],t[2],n.mouseX,n.mouseY))})),void e.preventDefault();if(0==at(e)&&"w"==e.key)return i(ot({},e=>{const t=Array.from(m(3,Q(e)));return $e(e,ke(t[0],t[1],t[2],n.mouseX,n.mouseY))})),void e.preventDefault();if(0==at(e)&&"a"==e.key)return i(ot({},e=>{const t=Oe(e.nodes,2,n.mouseX,n.mouseY);return 2!=t.length||"terminal"!=e.nodes[t[0]].type||"terminal"!=e.nodes[t[1]].type?"no nearby terminals found":function(e,t,n){const i=(e=new Ae(e)).node(t),l=e.node(n);if("terminal"!=i.type||"terminal"!=l.type)throw"cannot join non-terminals";const a=i.line(0),c=l.line(0);let u=j(e.rawDiagram);if(a.id==c.id){if(0!=a.direction)return"cannot form a directed loop";u.superlines[a.superlineId].weight+=2}else{const e=ue(a.reverse().line,c.line),t=o([a.node(1).index,a.lineIndex(1)],[c.node(1).index,c.lineIndex(1)],s)>0?oe:r;u.lines[a.id]=t(e.line),c.rawAssign(u,1,a.id),a.superlineId!=c.superlineId&&(u.superlines[a.superlineId]=te(c.superline,a.superline,{phase:e.phase}),u.superlines[c.superlineId]=Z),u.deltas=Y(u.deltas,[e.delta])}return delete u.lines[c.id],u.nodes=y(u.nodes,[i.index,l.index]),new Ae(u).removeUnusedSuperlines().rawDiagram}(e,t[0],t[1])})),void e.preventDefault();if(0==at(e)&&"m"==e.key&&"line"==n.hover.type)return i(ot({},e=>ze(e,n.hover.lineId))),void e.preventDefault();if(0==at(e)&&"j"==e.key){if("line"==n.hover.type)return i(ot({},e=>function(e,t){return(e=new Ae(e)).substitute({},{[e.line(t).superlineId]:{phase:2}}).rawDiagram}(e,n.hover.lineId))),void e.preventDefault();if("node"==n.hover.type)return i(ot({},e=>De(e,n.hover.nodeIndex))),void e.preventDefault()}if(0==at(e)&&"x"==e.key)return i(ot({},e=>{const t=e.nodes,r=Oe(t,1,n.mouseX,n.mouseY);return 1!=r.length||"terminal"==t[r[0]].type&&"terminal"!=t[ve(t,r[0],0)].type?"no nearby nodes found":function(e,t){const n=(e=j(e)).nodes[t];if("terminal"==n.type){const r=ve(e.nodes,t,0);if("terminal"!=e.nodes[r].type)throw new Error("cannot delete terminal of node");const i=e.lines[n.lines[0]].superline;delete e.lines[n.lines[0]],Pe(e,i)&&delete e.superlines[i],e.nodes=y(e.nodes,[t,r])}else{let r=[];n.lines.forEach(function(i,s){const o=ve(e.nodes,t,s);if(o==t){const t=e.lines[i];if(!t)return;delete e.lines[i];const n=t.superline;return void(Pe(e,n)&&delete e.superlines[n])}o<t&&(e.lines[i]=oe(e.lines[i])),r.push(ge(i,i,n.x,n.y))}),e.nodes.splice(t,1),e.nodes=r.concat(e.nodes)}return e}(e,r[0])})),void e.preventDefault();if(0==at(e)&&"s"==e.key){const e=document.getElementById("diagram");let n=e.cloneNode(!0);const r=e.getBoundingClientRect();n.setAttribute("viewBox",`0 0 ${r.width} ${r.height}`),l=t(),vt(n,e=>{let t=[];for(const n of Object.keys(l))if(e.matches(n)){const r=l[n];for(const n of Object.keys(r)){const i=n.replace(/[A-Z]/g,e=>"-"+e.toLowerCase());"transform"==i?e.setAttribute(i,r[n]):g(i)&&t.push(i+": "+r[n])}}const n=e.getAttribute("style");n&&t.push(n),t.length&&e.setAttribute("style",t.join("; "))}),vt(n,e=>{const t=e.getAttribute("href");t&&(e.removeAttribute("href"),e.setAttributeNS(C.xlink,"href",t))});const i=URL.createObjectURL(new Blob([(new XMLSerializer).serializeToString(n)],{type:"image/svg+xml;charset=utf-8"}));let s=document.createElement("a");s.href=i,s.download="diagram.svg",document.getElementsByTagName("body")[0].appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(i)}var l;jt=e.key}}}function xt(e){return(...t)=>{const n=xt(e),r=t.length;for(let n=0;n<r;++n)t[n](e);!function(e){if(X.push(e),1==X.length)for(;X.length;)X[0].forEach(e=>{const t=e.element;if(!t)throw new Error("invalid elem");e.attributes&&R(e.attributes,t),B(e.children,t)}),X.shift()}(st(n,e))}}!function(){let e={};Object.assign(e,nt()),xt(e)(rt)}()})()})();
//# sourceMappingURL=index.js.map